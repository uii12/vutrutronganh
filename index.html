<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flower Ring Galaxy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        body { 
            margin: 0; 
            background: #000000;
            overflow: hidden; 
            font-family: 'Arial', sans-serif;
        }
        canvas { 
            display: block; 
            width: 100vw !important; 
            height: 100vh !important; 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 1;
        }
        .stars-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.8) 1px, transparent 1px);
            background-size: 10px 10px;
            z-index: 0;
            animation: twinkle 4s infinite;
        }
        @keyframes twinkle {
            0% { opacity: 0.5; }
            50% { opacity: 0.9; }
            100% { opacity: 0.5; }
        }
        .info {
            position: absolute;
            top: 70px;
            left: 10px;
            color: white;
            font-family: Arial, sans-serif;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            z-index: 3;
        }
        .hidden { display: none !important; }
        /* Spinner cho n√∫t */
        .spinner {
          display: inline-block;
          width: 18px;
          height: 18px;
          border: 2px solid #fff;
          border-top: 2px solid #ff6b6b;
          border-radius: 50%;
          animation: spin 0.7s linear infinite;
          margin-right: 8px;
          vertical-align: middle;
        }
        @keyframes spin {
          0% { transform: rotate(0deg);}
          100% { transform: rotate(360deg);}
        }
        /* Shrimp (pop/zoom) effect cho popup */
        .shrimp-popup {
          animation: scale-in 0.38s cubic-bezier(.68,-0.55,.27,1.55);
        }
        @keyframes scale-in {
          0% { transform: scale(0.7); opacity: 0; }
          80% { transform: scale(1.08); opacity: 1; }
          100% { transform: scale(1); opacity: 1; }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
    <canvas id="canvas" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:10;pointer-events:none;"></canvas>
    <div class="stars-bg"></div>
    
    <!-- Th√™m b·∫£ng h∆∞·ªõng d·∫´n -->
    <div class="help-panel">
        <div class="controls-header">
            <h3>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h3>
            <button class="close-btn"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="help-section">
            <div class="section-divider">
                <h4>ƒêi·ªÅu khi·ªÉn c∆° b·∫£n</h4>
            </div>
            <ul>
                <li><span class="label-pc">[PC]</span> Click ƒë√∫p chu·ªôt: ph√°t nh·∫°c v√† k√≠ch ho·∫°t hi·ªáu ·ª©ng camera</li>
                <li><span class="label-pc">[PC]</span> Click chu·ªôt ph·∫£i/Ph√≠m Space: K√≠ch ho·∫°t hi·ªáu ·ª©ng bay c·ªßa v√≤ng ·∫£nh</li>
                <li><span class="label-mobile">[Mobile]</span>Double tap v√†o m√†n h√¨nh: ph√°t nh·∫°c v√† k√≠ch ho·∫°t hi·ªáu ·ª©ng camera</li>
                <li><span class="label-mobile">[Mobile]</span> ·∫§n v√†o M√≥n qu√† nh·ªè: K√≠ch ho·∫°t hi·ªáu ·ª©ng bay c·ªßa v√≤ng ·∫£nh</li>
            </ul>
        </div>

        <div class="help-section">
            <div class="section-divider">
                <h4>ƒêi·ªÅu ch·ªânh g√≥c nh√¨n</h4>
            </div>
            <ul>
                <li>Click v√† k√©o: Xoay camera</li>
                <li>Cu·ªôn chu·ªôt: Ph√≥ng to/thu nh·ªè</li>
                <li>Mobile: Vu·ªët ƒë·ªÉ xoay, ch·ª•m/t√°ch ƒë·ªÉ ph√≥ng to/thu nh·ªè</li>
            </ul>
        </div>

        <!-- <div class="help-section">
            <div class="section-divider">
                <h4>T√πy ch·ªânh <<ƒê·ªëi v·ªõi ng∆∞·ªùi t·∫°o>></h4>
            </div>
            <p>Nh·∫•n v√†o bi·ªÉu t∆∞·ª£ng C√ÄI ƒê·∫∂T ·ªü g√≥c ph·∫£i ƒë·ªÉ:</p>
            <ul>
                <li>Thay ƒë·ªïi m√†u s·∫Øc (h·∫°t, tinh c·∫ßu)</li>
                <li>ƒêi·ªÅu ch·ªânh t·ªëc ƒë·ªô xoay,t·ªëc ƒë·ªô bay c·ªßa ·∫£nh v√† h·∫°t</li>
                <li>Ch·ªçn ch·∫ø ƒë·ªô m√†u t·ª± ƒë·ªông ho·∫∑c t√πy ch·ªânh</li>
                <li>Thay ƒë·ªïi ·∫£nh v√† √¢m thanh</li>
            </ul>
        </div> -->
    </div>

 
    
   
    
   
    
    <!-- Icon h∆∞·ªõng d·∫´n l√πi xu·ªëng d∆∞·ªõi -->
    <div class="help-icon">
        <i class="fas fa-question-circle"></i>
    </div>
    
    <!-- B·∫£ng h∆∞·ªõng d·∫´n nhanh cho Mobile -->
    <div class="quick-help-panel mobile-help" id="mobileQuickHelp">
        <div class="quick-help-header">
            <h3>üì± H∆∞·ªõng d·∫´n Mobile</h3>
            <button class="quick-help-close-btn" onclick="closeQuickHelp('mobile')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="quick-help-content">
            <div class="quick-help-section">
                <h4>üéµ ƒêi·ªÅu khi·ªÉn nh·∫°c & Camera</h4>
                <p>Double tap v√†o m√†n h√¨nh ƒë·ªÉ k√≠ch ho·∫°t hi·ªáu ·ª©ng camera</p>
            </div>
            <div class="quick-help-section">
                <h4>üå∏ Hi·ªáu ·ª©ng bay v√≤ng ·∫£nh</h4>
                <p>·∫§n v√†o "M√≥n qu√† nh·ªè" ·ªü gi·ªØa m√†n h√¨nh ƒë·ªÉ k√≠ch ho·∫°t hi·ªáu ·ª©ng bay</p>
            </div>
            <div class="quick-help-section">
                <h4>‚òÑÔ∏è M∆∞a sao bƒÉng</h4>
                <p>T·ª± ƒë·ªông b·∫≠t khi thi√™n h√† c√≥ t√≠nh nƒÉng n√†y</p>
            </div>
            <div class="quick-help-section">
                <h4>üéÆ ƒêi·ªÅu khi·ªÉn camera</h4>
                <p>Vu·ªët ƒë·ªÉ xoay, ch·ª•m/t√°ch ƒë·ªÉ ph√≥ng to/thu nh·ªè</p>
            </div>
        </div>
    </div>

    <!-- B·∫£ng h∆∞·ªõng d·∫´n nhanh cho Desktop -->
    <div class="quick-help-panel desktop-help" id="desktopQuickHelp">
        <div class="quick-help-header">
            <h3>üíª H∆∞·ªõng d·∫´n Desktop</h3>
            <button class="quick-help-close-btn" onclick="closeQuickHelp('desktop')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="quick-help-content">
            <div class="quick-help-section">
                <h4>üéµ ƒêi·ªÅu khi·ªÉn nh·∫°c & Camera</h4>
                <p>Click ƒë√∫p chu·ªôt ƒë·ªÉ k√≠ch ho·∫°t hi·ªáu ·ª©ng camera</p>
            </div>
            <div class="quick-help-section">
                <h4>üå∏ Hi·ªáu ·ª©ng bay v√≤ng ·∫£nh</h4>
                <p>Click chu·ªôt ph·∫£i ho·∫∑c nh·∫•n ph√≠m Space ƒë·ªÉ k√≠ch ho·∫°t hi·ªáu ·ª©ng bay</p>
            </div>
            <div class="quick-help-section">
                <h4>‚òÑÔ∏è M∆∞a sao bƒÉng</h4>
                <p>T·ª± ƒë·ªông b·∫≠t khi thi√™n h√† c√≥ t√≠nh nƒÉng n√†y</p>
            </div>
            <div class="quick-help-section">
                <h4>üéÆ ƒêi·ªÅu khi·ªÉn camera</h4>
                <p>Click v√† k√©o ƒë·ªÉ xoay, cu·ªôn chu·ªôt ƒë·ªÉ ph√≥ng to/thu nh·ªè</p>
            </div>
        </div>
    </div>
    
    <!-- N√∫t M√≥n qu√† nh·ªè ·ªü ch√≠nh gi·ªØa tr√™n c√πng m√†n h√¨nh -->
    <button id="gift-btn" class="gift-btn">M√≥n qu√† nh·ªè</button>

    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
        "three/addons/controls/OrbitControls.js": "https://unpkg.com/three@0.152.2/examples/jsm/controls/OrbitControls.js",
        "three/addons/loaders/FontLoader.js": "https://unpkg.com/three@0.152.2/examples/jsm/loaders/FontLoader.js",
        "three/addons/geometries/TextGeometry.js": "https://unpkg.com/three@0.152.2/examples/jsm/geometries/TextGeometry.js",
        "three/addons/utils/BufferGeometryUtils.js": "https://unpkg.com/three@0.152.2/examples/jsm/utils/BufferGeometryUtils.js",
        "three/addons/loaders/GLTFLoader.js": "https://unpkg.com/three@0.152.2/examples/jsm/loaders/GLTFLoader.js"
      }
    }
    </script>
    
    <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { FontLoader } from 'three/addons/loaders/FontLoader.js';
    import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';
    import { AudioManager } from './js/audio.js';
    import { ParticleSystem } from './js/particles.js';
    import { CentralSphere } from './js/sphere.js';
    import { FlowerRingSystem } from './js/flowerRing.js';
    import { CameraController } from './js/camera.js';
    import { Heart } from './js/modelGlb.js';
    // import { processPayment, createPaymentModal, showToast } from './js/payment.js';

    // X·ª≠ l√Ω s·ª± ki·ªán cho b·∫£ng h∆∞·ªõng d·∫´n
    const helpIcon = document.querySelector('.help-icon');
    const helpPanel = document.querySelector('.help-panel');
    const helpCloseBtn = helpPanel.querySelector('.close-btn');

    helpIcon.addEventListener('click', () => {
        // M·ªü b·∫±ng icon - c≈©ng hi·ªÉn th·ªã ·ªü gi·ªØa m√†n h√¨nh
        helpPanel.classList.add('center');
        helpPanel.classList.add('active');
    });

    helpCloseBtn.addEventListener('click', () => {
        helpPanel.classList.remove('active', 'center');
    });

    // ƒê√≥ng b·∫£ng h∆∞·ªõng d·∫´n khi click ngo√†i
    document.addEventListener('click', (e) => {
        if (helpPanel.classList.contains('active') && 
            !helpPanel.contains(e.target) && 
            !helpIcon.contains(e.target)) {
            helpPanel.classList.remove('active', 'center');
        }
    });

    // Scene setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 5000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x000000);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);
    window.renderer = renderer;

    // Add ambient light
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);

    // Add point lights
    const light1 = new THREE.PointLight(0xffffff, 1, 500);
    light1.position.set(100, 100, 100);
    scene.add(light1);
    
    const light2 = new THREE.PointLight(0xffffff, 0.5, 500);
    light2.position.set(-100, -100, -100);
    scene.add(light2);

    // Kh·ªüi t·∫°o AudioManager duy nh·∫•t
    if (!window.audioManager) {
        window.audioManager = new AudioManager();
    }

    // Initialize systems
    const audioManager = window.audioManager;
    const particleSystem = new ParticleSystem(scene);
    window.particleSystem = particleSystem;
    const centralSphere = new CentralSphere(scene);
    window.centralSphere = centralSphere;
    centralSphere.setParticleSystem(particleSystem);
    const flowerRingSystem = new FlowerRingSystem(scene);
    centralSphere.setFlowerRing(flowerRingSystem);
    const cameraController = new CameraController(camera, renderer);
    const heart = new Heart(scene);

    // Handle window resize
    window.addEventListener('resize', () => {
        renderer.setSize(window.innerWidth, window.innerHeight);
        cameraController.handleResize();
    });

    // Double-click handler for desktop
    window.addEventListener('dblclick', (event) => {
        event.preventDefault();
        console.log('Double-click detected!');
        audioManager.playOnly();
        cameraController.triggerAnimation();
    });

    // Double tap handler for mobile
    let lastTap = 0;
    let tapCount = 0;
    let tapTimer = null;
    let lastTapX = 0;
    let lastTapY = 0;
    let isZooming = false;

    const handleDoubleTap = (event) => {
        // Ki·ªÉm tra n·∫øu ƒëang zoom th√¨ b·ªè qua
        if (isZooming) {
            return;
        }

        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        
        // L·∫•y t·ªça ƒë·ªô t·ª´ changedTouches (cho touchend) ho·∫∑c touches (cho touchstart)
        let currentX, currentY;
        if (event.changedTouches && event.changedTouches.length > 0) {
            currentX = event.changedTouches[0].clientX;
            currentY = event.changedTouches[0].clientY;
        } else if (event.touches && event.touches.length > 0) {
            currentX = event.touches[0].clientX;
            currentY = event.touches[0].clientY;
        } else {
            currentX = event.clientX || 0;
            currentY = event.clientY || 0;
        }
        
        // T√≠nh kho·∫£ng c√°ch gi·ªØa 2 tap
        const distance = Math.sqrt(
            Math.pow(currentX - lastTapX, 2) + 
            Math.pow(currentY - lastTapY, 2)
        );
        
        // Double tap detected: th·ªùi gian < 600ms, kho·∫£ng c√°ch < 30px, v√† kh√¥ng ph·∫£i zoom
        if (tapLength < 600 && tapLength > 100 && distance < 30) {
            console.log('Double tap detected!');
            event.preventDefault();
            event.stopPropagation();
            
            // Clear any pending single tap
            if (tapTimer) {
                clearTimeout(tapTimer);
                tapTimer = null;
            }
            
            // Trigger the same actions as double click
            audioManager.playOnly();
            cameraController.triggerAnimation();
            
            // Reset tap count
            tapCount = 0;
        } else {
            // Single tap - wait to see if it becomes a double tap
            tapCount++;
            if (tapCount === 1) {
                tapTimer = setTimeout(() => {
                    // Single tap confirmed
                    tapCount = 0;
                }, 600);
            }
        }
        
        lastTap = currentTime;
        lastTapX = currentX;
        lastTapY = currentY;
    };

    // Detect zoom gesture
    let initialDistance = 0;
    const handleTouchStart = (event) => {
        if (event.touches.length === 2) {
            initialDistance = Math.sqrt(
                Math.pow(event.touches[0].clientX - event.touches[1].clientX, 2) +
                Math.pow(event.touches[0].clientY - event.touches[1].clientY, 2)
            );
            isZooming = true;
        }
    };

    const handleTouchEnd = () => {
        // Reset zoom state after a delay
        setTimeout(() => {
            isZooming = false;
        }, 300);
    };

    // Add double tap listener for mobile (ch·ªâ d√πng document)
    const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
    if (isMobile) {
        document.addEventListener('touchend', handleDoubleTap);
        document.addEventListener('touchstart', handleTouchStart);
        document.addEventListener('touchend', handleTouchEnd);
    }

    // Th√™m x·ª≠ l√Ω click chu·ªôt ph·∫£i
    window.addEventListener('contextmenu', (event) => {
        event.preventDefault();
        console.log('Right click detected!');
        if (flowerRingSystem) {
            console.log('Triggering flying effect');
            flowerRingSystem.triggerFlyingEffect();
        }
    });

    // Th√™m x·ª≠ l√Ω ph√≠m t·∫Øt (ph√≠m Space)
    window.addEventListener('keydown', (event) => {
        if (event.code === 'Space') {
            event.preventDefault();
            console.log('Space key detected!');
            if (flowerRingSystem) {
                console.log('Triggering flying effect');
                flowerRingSystem.triggerFlyingEffect();
            }
        }
        // B·ªè ph√≠m Enter ƒë·ªÉ b·∫≠t/t·∫Øt m∆∞a sao bƒÉng - ch·ªâ d√πng n√∫t tr√™n mobile
    });

    // Animation loop
    function animate() {
        requestAnimationFrame(animate);
        
        particleSystem.animate();
        centralSphere.animate();
        flowerRingSystem.animate();
        cameraController.update();
        heart.animate();
        
        renderer.render(scene, camera);
    }

    animate();

    // Trong <script type="module">, sau khi kh·ªüi t·∫°o flowerRingSystem
    const giftBtn = document.getElementById('gift-btn');
    if (giftBtn) {
        giftBtn.addEventListener('click', () => {
            if (flowerRingSystem) {
                console.log('Triggering flying effect from gift button');
                flowerRingSystem.triggerFlyingEffect();
            }
            giftBtn.style.display = 'none';
        });
    }

    // Sau khi x·ª≠ l√Ω DOMContentLoaded, n·∫øu l√† web con th√¨ ƒë·∫©y icon √¢m thanh l√™n v·ªã tr√≠ icon c√†i ƒë·∫∑t
    window.addEventListener('DOMContentLoaded', () => {
        const hash = window.location.hash;
        
       
        
        // X·ª≠ l√Ω cho web con (c√≥ #config= ho·∫∑c #id=)
        if (hash.startsWith('#config=') || hash.startsWith('#id=')) {
            // ·∫®n n√∫t Google login tri·ªát ƒë·ªÉ
            const googleLoginBtn = document.getElementById('googleLoginBtn');
            if (googleLoginBtn) {
                googleLoginBtn.style.display = 'none';
                googleLoginBtn.classList.add('hidden');
            }
           
            // ƒê∆∞a n√∫t h∆∞·ªõng d·∫´n l√™n v·ªã tr√≠ g√≥c tr√™n tr√°i (thay v·ªã tr√≠ login)
            const helpIcon = document.querySelector('.help-icon');
            if (helpIcon) {
                helpIcon.style.position = 'fixed';
                helpIcon.style.top = '20px';
                helpIcon.style.left = '20px';
                helpIcon.style.right = '';
                helpIcon.style.zIndex = 1003;
                helpIcon.style.marginLeft = '0';
            }
        }
        
        // Hi·ªÉn th·ªã b·∫£ng h∆∞·ªõng d·∫´n nhanh khi m·ªü web
        setTimeout(() => {
            // Ch·ªâ hi·ªÉn th·ªã b·∫£ng h∆∞·ªõng d·∫´n nhanh tr√™n web con (c√≥ config ho·∫∑c id)
            if (hash.startsWith('#config=') || hash.startsWith('#id=')) {
                showQuickHelp();
            }
            // Hi·ªÉn th·ªã b·∫£ng h∆∞·ªõng d·∫´n ch√≠nh cho web cha (c·∫£ desktop v√† mobile)
            else {
                showMainHelp();
            }
        }, 1000); // ƒê·ª£i 1 gi√¢y ƒë·ªÉ trang load ho√†n to√†n
    });
    
    // H√†m hi·ªÉn th·ªã b·∫£ng h∆∞·ªõng d·∫´n nhanh
    function showQuickHelp() {
        const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
        const mobileHelp = document.getElementById('mobileQuickHelp');
        const desktopHelp = document.getElementById('desktopQuickHelp');
        
        if (isMobile && mobileHelp) {
            mobileHelp.classList.add('active');
        } else if (!isMobile && desktopHelp) {
            desktopHelp.classList.add('active');
        }
    }
    
    // H√†m ƒë√≥ng b·∫£ng h∆∞·ªõng d·∫´n nhanh
    function closeQuickHelp(type) {
        const helpPanel = document.getElementById(type + 'QuickHelp');
        if (helpPanel) {
            helpPanel.classList.remove('active');
            // Ph√°t nh·∫°c khi ƒë√≥ng b·∫£ng h∆∞·ªõng d·∫´n
            if (window.audioManager) {
                window.audioManager.playOnly();
            }
        }
    }
    
    // Th√™m v√†o global scope ƒë·ªÉ c√≥ th·ªÉ g·ªçi t·ª´ onclick
    window.closeQuickHelp = closeQuickHelp;
    
    // ƒê√≥ng b·∫£ng h∆∞·ªõng d·∫´n khi click b√™n ngo√†i
    document.addEventListener('click', (event) => {
        const mobileHelp = document.getElementById('mobileQuickHelp');
        const desktopHelp = document.getElementById('desktopQuickHelp');
        
        if (mobileHelp && mobileHelp.classList.contains('active') && 
            !mobileHelp.contains(event.target) && 
            !event.target.closest('.quick-help-close-btn')) {
            mobileHelp.classList.remove('active');
            // Ph√°t nh·∫°c khi ƒë√≥ng b·∫£ng h∆∞·ªõng d·∫´n
            if (window.audioManager) {
                window.audioManager.playOnly();
            }
        }
        
        if (desktopHelp && desktopHelp.classList.contains('active') && 
            !desktopHelp.contains(event.target) && 
            !event.target.closest('.quick-help-close-btn')) {
            desktopHelp.classList.remove('active');
            // Ph√°t nh·∫°c khi ƒë√≥ng b·∫£ng h∆∞·ªõng d·∫´n
            if (window.audioManager) {
                window.audioManager.playOnly();
            }
        }
    });

    // H√†m hi·ªÉn th·ªã b·∫£ng h∆∞·ªõng d·∫´n ch√≠nh cho web cha
    function showMainHelp() {
        const helpPanel = document.querySelector('.help-panel');
        if (helpPanel) {
            // L·∫ßn ƒë·∫ßu m·ªü - hi·ªÉn th·ªã ·ªü gi·ªØa m√†n h√¨nh
            helpPanel.classList.add('center');
            helpPanel.classList.add('active');
        }
    }
    </script>

    <script type="module" src="./js/sphere.js"></script>
    <div id="flower-loading-overlay" style="display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(255,255,255,0.5);backdrop-filter:blur(4px);z-index:9999;pointer-events:none;"></div>
    <audio id="bg-audio" style="display:none"></audio>
    <canvas id="canvas" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:10;pointer-events:none;"></canvas>
    <script src="./js/meteors.js"></script>
</body>
</html>